repo,test_patch,problem_statement,FAIL_TO_PASS,PASS_TO_PASS,language
caddyserver/caddy,"diff --git a/modules/caddyhttp/reverseproxy/selectionpolicies_test.go b/modules/caddyhttp/reverseproxy/selectionpolicies_test.go
index 9199f61988c..d7e79626c1b 100644
--- a/modules/caddyhttp/reverseproxy/selectionpolicies_test.go
+++ b/modules/caddyhttp/reverseproxy/selectionpolicies_test.go
@@ -658,6 +658,9 @@ func TestCookieHashPolicy(t *testing.T) {
 	if cookieServer1.Name != ""lb"" {
 		t.Error(""cookieHashPolicy should set a cookie with name lb"")
 	}
+	if cookieServer1.Secure {
+		t.Error(""cookieHashPolicy should set cookie Secure attribute to false when request is not secure"")
+	}
 	if h != pool[0] {
 		t.Error(""Expected cookieHashPolicy host to be the first only available host."")
 	}
@@ -687,6 +690,57 @@ func TestCookieHashPolicy(t *testing.T) {
 	}
 }
 
+func TestCookieHashPolicyWithSecureRequest(t *testing.T) {
+    ctx, cancel := caddy.NewContext(caddy.Context{Context: context.Background()})
+    defer cancel()
+    cookieHashPolicy := CookieHashSelection{}
+    if err := cookieHashPolicy.Provision(ctx); err != nil {
+        t.Errorf(""Provision error: %v"", err)
+        t.FailNow()
+    }
+
+    pool := testPool()
+    pool[0].Dial = ""localhost:8080""
+    pool[1].Dial = ""localhost:8081""
+    pool[2].Dial = ""localhost:8082""
+    pool[0].setHealthy(true)
+    pool[1].setHealthy(false)
+    pool[2].setHealthy(false)
+
+    // Create a test server that serves HTTPS requests
+    ts := httptest.NewTLSServer(http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
+        h := cookieHashPolicy.Select(pool, r, w)
+        if h != pool[0] {
+            t.Error(""Expected cookieHashPolicy host to be the first only available host."")
+        }
+    }))
+    defer ts.Close()
+
+    // Make a new HTTPS request to the test server
+    client := ts.Client()
+    request, err := http.NewRequest(http.MethodGet, ts.URL+""/test"", nil)
+    if err != nil {
+        t.Fatal(err)
+    }
+    response, err := client.Do(request)
+    if err != nil {
+        t.Fatal(err)
+    }
+
+    // Check if the cookie set is Secure and has SameSiteNone mode
+    cookies := response.Cookies()
+    if len(cookies) == 0 {
+        t.Fatal(""Expected a cookie to be set"")
+    }
+    cookie := cookies[0]
+    if !cookie.Secure {
+        t.Error(""Expected cookie Secure attribute to be true when request is secure"")
+    }
+    if cookie.SameSite != http.SameSiteNoneMode {
+        t.Error(""Expected cookie SameSite attribute to be None when request is secure"")
+    }
+}
+
 func TestCookieHashPolicyWithFirstFallback(t *testing.T) {
 	ctx, cancel := caddy.NewContext(caddy.Context{Context: context.Background()})
 	defer cancel()
","Sticky cookie should be Secure and SameSite=None by default
A common legacy-app routing setup looks like this:

```
reverse_proxy tomcat_serverA:8080 tomcat_serverB:8080 {
    lb_policy cookie
}
```

The result might be:

```
$ curl -I https://demo.example/portal/
HTTP/2 200
cache-control: no-store, no-cache, must-revalidate, max-age=0, post-check=0, pre-check=0
content-type: text/html;charset=UTF-8
date: Fri, 16 Feb 2024 21:54:13 GMT
pragma: no-cache
server: Caddy
set-cookie: lb=b4b924ab173004e449881468ab25c0aa4197efd974ae8c007a7164869c261a69; Path=/
```

The problem for a Chrome user is that if they arrive from a third-party link, the lb cookie will not be sent to Caddy as the cookie was not set with SameSite=None property.

While setting SameSite=None is a fun debate for applications and their CSRF protections, Caddy doesn't have a potential CSRF vulnerability so SameSite=None as the default makes sense. We want the ""sticky"" user to always end up on the same upstream if they come from a third-party website, from a bookmark, or from a same-site link.
",['TestCookieHashPolicyWithSecureRequest'],"['TestParseUpstreamDialAddress', 'TestEqualFold', 'TestIsPrint', 'TestRoundRobinPolicy', 'TestWeightedRoundRobinPolicy', 'TestLeastConnPolicy', 'TestIPHashPolicy', 'TestClientIPHashPolicy', 'TestFirstPolicy', 'TestQueryHashPolicy', 'TestURIHashPolicy', 'TestLeastRequests', 'TestRandomChoicePolicy', 'TestCookieHashPolicy', 'TestCookieHashPolicyWithFirstFallback', 'TestHandlerCopyResponse']",Go
