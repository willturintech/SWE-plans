repo,test_patch,problem_statement,FAIL_TO_PASS,PASS_TO_PASS,language
preactjs/preact,"diff --git a/test/browser/refs.test.js b/test/browser/refs.test.js
index 7e4224af57..b096955ce5 100644
--- a/test/browser/refs.test.js
+++ b/test/browser/refs.test.js
@@ -715,4 +715,36 @@ describe('refs', () => {
 		render(<App />, scratch);
 		render(<App show />, scratch);
 	});
+
+	it('should call ref cleanup on unmount', () => {
+		const cleanup = sinon.spy();
+		const ref = sinon.spy(() => cleanup);
+
+		function App({ show = false }) {
+			return <div>{show && <p ref={ref}>hello</p>}</div>;
+		}
+
+		render(<App show />, scratch);
+		render(<App />, scratch);
+
+		expect(cleanup).to.be.calledOnce;
+
+		// Ref should not be called with `null` when cleanup is present
+		expect(ref).to.be.calledOnce;
+		expect(ref).not.to.be.calledWith(null);
+	});
+
+	it('should call ref cleanup when ref changes', () => {
+		const cleanup = sinon.spy();
+
+		function App({ show = false, count = 0 }) {
+			return <div>{show && <p ref={() => cleanup}>hello {count}</p>}</div>;
+		}
+
+		render(<App show />, scratch);
+		render(<App show count={1} />, scratch);
+
+		// Cleanup should be invoked whenever ref function changes
+		expect(cleanup).to.be.calledOnce;
+	});
 });
","Support cleanup functions for refs
**Describe the feature you'd love to see**
Similar to the new [React 19 feature](https://react.dev/blog/2024/04/25/react-19#cleanup-functions-for-refs), it would be great to be able to use cleanup functions with callback refs. 

```jsx
<input
  ref={(ref) => {
    // ref created

    // REQUESTED: return a cleanup function to reset
    // the ref when element is removed from DOM.
    return () => {
      // ref cleanup
    };
  }}
/>
```

This would make it easier to connect Preact components to DOM APIs like MutationObserver, which currently need some hooks/effects. Using object refs and effects is more error-prone as it requires syncing up whatever conditional rendering logic you have between your returned elements and effects.

**Additional context (optional)**
https://react.dev/blog/2024/04/25/react-19#cleanup-functions-for-refs

","['refs > should call ref cleanup on unmount', 'refs > should call ref cleanup when ref changes']","['refs > should invoke refs in render()', 'refs > should not call stale refs', 'refs > should support createRef', 'refs > should invoke refs in Component.render()', 'refs > should pass components to ref functions', 'refs > should have a consistent order', 'refs > should pass rendered DOM from functional components to ref functions', 'refs > should pass children to ref functions', 'refs > should pass high-order children to ref functions', 'refs > should not pass ref into component as a prop', 'refs > should only null refs after unmount', 'refs > should null and re-invoke refs when swapping component root element type', 'refs > should add refs to components representing DOM nodes with no attributes if they have been pre-rendered', 'refs > should call ref after children are rendered', 'refs > should correctly set nested child refs', 'refs > should correctly call child refs for un-keyed children on re-render', 'refs > should not remove refs for memoized components keyed', 'refs > should not remove refs for memoized components unkeyed', 'refs > should properly call null for memoized components keyed', 'refs > should properly call null for memoized components unkeyed', 'refs > should first clean-up refs and after apply them', 'refs > should bind refs before componentDidMount', 'refs > should call refs after element is added to document on initial mount', 'refs > should call refs after element is added to document on update']",JS/TS
